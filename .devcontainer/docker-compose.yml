name: ignis-dev-services

networks:
  op:
    name: op
    internal: true
  ignis-dev:
    name: ignis-dev

secrets:
  ca_cert:
    file: ../config/secret/db/ca_cert.pem
  db_cert:
    file: ../config/secret/db/ignis_cert.pem
  db_key:
    file: ../config/secret/db/ignis_key.pem


services:
  devcontainer:
    build:
      dockerfile: ./.devcontainer/Dockerfile
      context: ..
    container_name: ignis-dev-devcontainer
    env_file:
      - ../.env
    environment:
      EDGEDB_TLS_CA_FILE: /run/secrets/ca_cert
    networks:
      - op
      - ignis-dev
    secrets:
      - ca_cert
      - db_cert
      - db_key
    depends_on:
      db:
        condition: service_healthy
      op-connect-api:
        condition: service_started
      op-connect-sync:
        condition: service_started
      valkey:
        condition: service_started
      mailhog:
        condition: service_started

  db:
    image: edgedb/edgedb:5
    container_name: ignis-dev-db
    env_file:
      - ../config/secret/db/.env
    environment:
      EDGEDB_SERVER_TLS_CERT_MODE: require_file
      EDGEDB_SERVER_TLS_KEY_FILE: /ignis_certs/ignis_key.pem
      EDGEDB_SERVER_TLS_CERT_FILE: /ignis_certs/ignis_cert.pem
      EDGEDB_SERVER_TLS_CA_FILE: /ignis_certs/ca_cert.pem
    networks:
      - ignis-dev
    volumes:
      - 'db_data:/var/lib/edgedb/data'
      - '../apps/anvil/dbschema:/dbschema:ro'
      - ../config/secret/db:/ignis_certs:ro
    healthcheck:
      test: curl --fail http://db:5656/server/status/ready || exit 1
      interval: 8s
      retries: 10
      start_period: 6s
      timeout: 10s


  op-connect-api:
    image: 1password/connect-api:latest
    ports:
      - "8080:8080"
    volumes:
      - "../config/secret/op/1password-credentials.json:/home/opuser/.op/1password-credentials.json:ro"
      - "1p_data:/home/opuser/.op/data"
    container_name: ignis-dev-op-api
    networks:
      - op

  op-connect-sync:
    image: 1password/connect-sync:latest
    volumes:
      - "../config/secret/op/1password-credentials.json:/home/opuser/.op/1password-credentials.json:ro"
      - "1p_data:/home/opuser/.op/data"
    container_name: ignis-dev-op-sync
    networks:
      - op

  valkey:
    image: valkey/valkey:latest
    container_name: ignis-dev-kv
    volumes:
      - 'kv_data:/bitnami/valkey/data'
    networks:
      - ignis-dev
    env_file:
      - ../.env
    command: ["valkey-server", "--requirepass", "${KV_PASSWORD}"]

  mailhog:
    image: jcalonso/mailhog:latest
    container_name: ignis-dev-mail
    networks:
      - ignis-dev
    ports:
      - "8025:8025"

volumes:
  db_data:
    driver: local
    labels:
      com.ignis.description: "IGNIS - EdgeDB data volume"
  kv_data:
    driver: local
    labels:
      com.ignis.description: "IGNIS - Valkey data volume"
  1p_data:
    driver: local
    labels:
      com.ignis.description: "IGNIS - 1Password data volume"