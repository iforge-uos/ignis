Code taken from 33aa7fa+162. Remember to update this if the code needs patches applying
